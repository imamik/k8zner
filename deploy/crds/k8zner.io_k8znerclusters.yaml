---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: k8znerclusters.k8zner.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: k8zner.io
  names:
    kind: K8znerCluster
    listKind: K8znerClusterList
    plural: k8znerclusters
    singular: k8znercluster
    shortNames:
      - k8z
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: CPs
          type: string
          jsonPath: .status.controlPlanes.ready
        - name: Workers
          type: string
          jsonPath: .status.workers.ready
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          description: K8znerCluster is the Schema for the k8znerclusters API.
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              description: K8znerClusterSpec defines the desired state of a K8zner-managed cluster.
              required:
                - region
                - controlPlanes
                - workers
              properties:
                region:
                  type: string
                  description: Region is the Hetzner Cloud region
                  enum: [fsn1, nbg1, hel1, ash, hil]
                controlPlanes:
                  type: object
                  description: ControlPlanes defines the control plane configuration
                  properties:
                    count:
                      type: integer
                      description: Count is the number of control plane nodes
                      enum: [1, 3, 5]
                      default: 1
                    size:
                      type: string
                      description: Size is the Hetzner server type
                      default: cx22
                workers:
                  type: object
                  description: Workers defines the worker node configuration
                  required:
                    - count
                  properties:
                    count:
                      type: integer
                      description: Count is the desired number of worker nodes
                      minimum: 1
                      maximum: 100
                    size:
                      type: string
                      description: Size is the Hetzner server type
                      default: cx22
                    minCount:
                      type: integer
                      description: MinCount is the minimum number of workers
                      minimum: 0
                      default: 1
                    maxCount:
                      type: integer
                      description: MaxCount is the maximum number of workers
                      maximum: 100
                      default: 10
                backup:
                  type: object
                  description: Backup configures automated etcd backups
                  properties:
                    enabled:
                      type: boolean
                      description: Enabled turns on automated backups
                    schedule:
                      type: string
                      description: Schedule is the cron schedule for backups
                      default: "0 * * * *"
                    retention:
                      type: string
                      description: Retention is how long to keep backups
                      default: "168h"
                healthCheck:
                  type: object
                  description: HealthCheck configures health monitoring thresholds
                  properties:
                    nodeNotReadyThreshold:
                      type: string
                      description: NodeNotReadyThreshold is how long a node can be NotReady
                      default: "5m"
                    etcdUnhealthyThreshold:
                      type: string
                      description: EtcdUnhealthyThreshold is how long etcd can be unhealthy
                      default: "2m"
                addons:
                  type: object
                  description: Addons specifies which addons should be installed
                  properties:
                    traefik:
                      type: boolean
                      default: true
                    certManager:
                      type: boolean
                      default: true
                    externalDns:
                      type: boolean
                    argocd:
                      type: boolean
                    metricsServer:
                      type: boolean
                      default: true
                paused:
                  type: boolean
                  description: Paused stops the operator from reconciling this cluster
            status:
              type: object
              description: K8znerClusterStatus defines the observed state of K8znerCluster.
              properties:
                phase:
                  type: string
                  description: Phase is the overall cluster phase
                  enum: [Provisioning, Running, Degraded, Healing, Failed]
                controlPlanes:
                  type: object
                  description: ControlPlanes shows the status of control plane nodes
                  properties:
                    desired:
                      type: integer
                    ready:
                      type: integer
                    unhealthy:
                      type: integer
                    nodes:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          serverID:
                            type: integer
                            format: int64
                          privateIP:
                            type: string
                          publicIP:
                            type: string
                          healthy:
                            type: boolean
                          unhealthyReason:
                            type: string
                          unhealthySince:
                            type: string
                            format: date-time
                          etcdMemberID:
                            type: string
                          lastHealthCheck:
                            type: string
                            format: date-time
                workers:
                  type: object
                  description: Workers shows the status of worker nodes
                  properties:
                    desired:
                      type: integer
                    ready:
                      type: integer
                    unhealthy:
                      type: integer
                    nodes:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          serverID:
                            type: integer
                            format: int64
                          privateIP:
                            type: string
                          publicIP:
                            type: string
                          healthy:
                            type: boolean
                          unhealthyReason:
                            type: string
                          unhealthySince:
                            type: string
                            format: date-time
                          lastHealthCheck:
                            type: string
                            format: date-time
                addons:
                  type: object
                  additionalProperties:
                    type: object
                    properties:
                      installed:
                        type: boolean
                      version:
                        type: string
                      healthy:
                        type: boolean
                      message:
                        type: string
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                lastReconcileTime:
                  type: string
                  format: date-time
                observedGeneration:
                  type: integer
                  format: int64

# Talos Bootstrap Investigation

## Problem Statement
Go implementation of Talos cluster bootstrap consistently fails with "tls: certificate required" error after applying machine configuration to pre-installed Talos nodes from Packer snapshots.

## Environment
- **Talos Version**: v1.8.3
- **Kubernetes Version**: v1.31.0
- **Platform**: Hetzner Cloud
- **Image Source**: Packer-built snapshots from Talos raw disk images
- **Working Reference**: Terraform setup in this repo successfully bootstraps clusters

## Symptoms
1. Machine configuration applies successfully (no error)
2. Node reboots successfully
3. Node comes back online (port 50000 accessible)
4. **Failure**: Cannot establish authenticated TLS connection
5. Error persists for 8+ minutes until 10-minute timeout

```
rpc error: code = Unavailable desc = connection error:
desc = "error reading server preface: remote error: tls: certificate required"
```

## Attempted Fixes

### Attempt 1: Change ApplyConfiguration Mode (AUTO → REBOOT)
**Rationale**: Terraform uses "auto" mode which effectively becomes REBOOT on pre-installed systems
**Implementation**: `bootstrap.go:185` changed from `AUTO` to `REBOOT`
**Result**: ❌ Failed - same error

### Attempt 2: Use Authenticated Connections
**Rationale**: Terraform's `talos_machine_configuration_apply` uses authenticated connections from start
**Implementation**: Modified `applyMachineConfig()` to parse client config and use authenticated client
**Result**: ❌ Failed - same error

### Attempt 3: Combined (REBOOT + Authenticated)
**Implementation**: Both changes applied together
**Result**: ❌ Failed - same error

## Key Findings

### Packer Image Creation
- Packer downloads Talos raw disk image from Image Factory
- Writes directly to `/dev/sda` using `dd`
- Creates snapshot of **pre-installed** Talos (not maintenance mode)
- Disk image is bootable, complete Talos installation

### Terraform Approach
- Uses `talos_machine_configuration_apply` resource
- Default `apply_mode = "auto"`
- Passes `client_configuration` (authenticated talosconfig)
- Applies to servers booted from pre-installed snapshots
- **Works reliably**

### Go Implementation
- Generates machine configs using Talos machinery library
- Attempts to apply configs to pre-installed nodes
- Uses both insecure and authenticated connection approaches
- **Fails consistently**

## Hypothesis
The fundamental approach may be incorrect for pre-installed Talos nodes. Possible issues:

1. **PKI Mismatch**: Pre-installed node might generate new certificates after config application that don't match our client config
2. **Timing Issue**: Node might need more time for PKI initialization than we're allowing
3. **Config Generation**: Machine configs generated by Go might be subtly different from Terraform's
4. **Missing Step**: Terraform provider might do something additional that we're not doing

## Next Steps

### 1. Study Terraform Provider Source Code
Look at `terraform-provider-talos` Go source to see exact implementation of `talos_machine_configuration_apply`.

### 2. Create Incremental E2E Tests
Build up from simplest case:
- **Test 1**: Create server from snapshot, verify Talos API accessible
- **Test 2**: Apply machine config to single node
- **Test 3**: Verify node becomes ready with authenticated connection
- **Test 4**: Bootstrap single-node cluster
- **Test 5**: Full multi-node cluster

### 3. Manual Testing
Use `talosctl` to manually apply config to a node from snapshot, observe the exact sequence of events.

### 4. Compare Configurations
Generate machine config with both Terraform and Go, diff them to find differences.

## Files Modified

### `internal/cluster/bootstrap.go`
- Changed `ApplyConfigurationRequest_AUTO` → `ApplyConfigurationRequest_REBOOT` (line 185)
- Modified `applyMachineConfig()` to accept and use `clientConfigBytes` for authentication
- Now creates authenticated client instead of insecure connection

### `internal/talos/config.go`
- Added `generate.WithInstallDisk("/dev/sda")` for both control plane and worker configs

### `internal/cluster/reconciler.go`
- Updated to pass `clientConfigBytes` to `applyMachineConfig()`

## Test Results

All E2E tests cleaned up and infrastructure deleted. No successful bootstrap yet.

## Resources Consulted
- Talos Documentation (v1.8, v1.10, v1.11)
- Terraform Talos Provider Registry
- GitHub Issues and Discussions for Talos
- Talos machinery library source code
